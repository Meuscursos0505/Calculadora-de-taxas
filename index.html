<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precify - Calculadoras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root { 
            --bg-dark: #111827; 
            --bg-card: #1F2937; 
            --border-color: #374151; 
            --text-light: #F9FAFB; 
            --text-secondary: #9CA3AF; 
            --accent-green: #34D399; 
            --accent-green-dark: #059669; 
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: var(--text-light); }
        
        /* === Marketplace Calc Styles === */
        .marketplace-sidebar { background-color: var(--bg-card); }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); }
        .input-field, .select-field { background-color: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-light); -webkit-appearance: none; appearance: none; }
        .select-field { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .input-field:focus, .select-field:focus { border-color: var(--accent-green); outline: none; box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.3); }
        
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--accent-green); border-radius: 50%; cursor: pointer; margin-top: -8px; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--accent-green); border-radius: 50%; cursor: pointer; }
        input[type="range"]::-webkit-slider-runnable-track { height: 4px; background: var(--border-color); border-radius: 2px; }
        input[type="range"]::-moz-range-track { height: 4px; background: var(--border-color); border-radius: 2px; }
        input[type="checkbox"] { accent-color: var(--accent-green); }

        /* === Accordion Styles (Sidebar & Cards) === */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        .details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .details-content.open {
            max-height: 500px; /* A value larger than the content will ever be */
            transition: max-height 0.6s ease-in;
        }
        .details-toggle svg, .sidebar-summary svg {
            transition: transform 0.3s ease;
        }
        .details-toggle.open svg, details[open] > .sidebar-summary svg {
            transform: rotate(180deg);
        }
        details[open] > .sidebar-summary {
            color: var(--accent-green);
        }

        /* === Tax Calc Styles & Sidebar === */
        #tax-calculator-sidebar {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateX(100%);
            opacity: 0;
            pointer-events: none;
            z-index: 50;
            background-color: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(4px);
        }
        #tax-calculator-sidebar.active {
            transform: translateX(0%);
            opacity: 1;
            pointer-events: auto;
        }
        #tax-calculator-sidebar .tax-calc-panel {
             background-color: var(--bg-card);
             color: var(--text-light);
        }
        #tax-calculator-sidebar .result-card-dark { 
            background-color: var(--bg-card); /* Changed for contrast */
            border-left: 4px solid var(--accent-green); 
        }
        #tax-calculator-sidebar .result-card-dark h3 { color: var(--text-secondary); }
        #tax-calculator-sidebar .result-card-dark p { color: var(--text-light); }
        #tax-calculator-sidebar .modal-overlay { transition: opacity 0.3s ease; }
        #tax-calculator-sidebar .modal-content { transition: transform 0.3s ease; background-color: var(--bg-card); }
        
    </style>
</head>
<body>
    <div class="lg:grid lg:grid-cols-12">
        <!-- Marketplace Sidebar -->
        <aside id="sidebar" class="lg:col-span-3 lg:h-screen lg:sticky top-0 p-6 marketplace-sidebar space-y-2 overflow-y-auto">
             <div class="mb-6">
                <h1 class="text-3xl font-bold text-white">Precify</h1>
                <p class="text-sm text-gray-400">Sua estratégia de lucro para marketplaces</p>
            </div>
            <div class="space-y-2">
                <details open>
                    <summary class="sidebar-summary flex justify-between items-center p-3 rounded-md hover:bg-gray-900/50 transition-colors cursor-pointer">
                        <span class="font-semibold text-lg text-white">Custos Principais</span>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="pt-4 space-y-4 pl-4 border-l border-gray-700 ml-3">
                        <div><label for="productCost" class="block text-sm font-medium text-gray-300">Custo do Produto (R$)</label><input type="number" id="productCost" class="input-field mt-1 block w-full rounded-md p-2" value=""></div>
                        <div><label for="productWeight" class="block text-sm font-medium text-gray-300">Peso (kg)</label><input type="number" id="productWeight" class="input-field mt-1 block w-full rounded-md p-2" value=""></div>
                        <div><label for="categorySelect" class="block text-sm font-medium text-gray-300">Categoria do Produto</label><select id="categorySelect" class="select-field mt-1 block w-full rounded-md p-2"></select></div>
                    </div>
                </details>

                <details>
                    <summary class="sidebar-summary flex justify-between items-center p-3 rounded-md hover:bg-gray-900/50 transition-colors cursor-pointer">
                        <span class="font-semibold text-lg text-white">Custos Adicionais</span>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="pt-4 space-y-3 pl-4 border-l border-gray-700 ml-3">
                        <div id="additional-costs-container" class="space-y-3"></div>
                        <button id="add-cost-btn" class="w-full text-center p-2 rounded-md border border-dashed border-gray-600 hover:bg-gray-700 hover:border-accent-green text-accent-green transition text-sm">+ Adicionar Custo</button>
                    </div>
                </details>

                <details>
                    <summary class="sidebar-summary flex justify-between items-center p-3 rounded-md hover:bg-gray-900/50 transition-colors cursor-pointer">
                        <span class="font-semibold text-lg text-white">Taxas & Frete</span>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="pt-4 space-y-4 pl-4 border-l border-gray-700 ml-3">
                        <div><label for="taxRate" class="block text-sm font-medium text-gray-300">Impostos (%)</label><input type="number" id="taxRate" class="input-field mt-1 block w-full rounded-md p-2" value=""></div>
                        <div>
                            <label for="shippingCost" class="block text-sm font-medium text-gray-300">Frete Manual (R$)</label>
                            <input type="number" id="shippingCost" class="input-field mt-1 block w-full rounded-md p-2" value="">
                            <p class="text-xs text-gray-400 mt-1">Ignorado para ML, Shein e TikTok.</p>
                        </div>
                    </div>
                </details>
                
                <details>
                    <summary class="sidebar-summary flex justify-between items-center p-3 rounded-md hover:bg-gray-900/50 transition-colors cursor-pointer">
                        <span class="font-semibold text-lg text-white">Configurações</span>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div class="pt-4 space-y-4 pl-4 border-l border-gray-700 ml-3">
                        <div><label for="mlReputation" class="block text-sm font-medium text-gray-300">Reputação Mercado Livre</label>
                            <select id="mlReputation" class="select-field mt-1 block w-full rounded-md p-2">
                                <option value="verde">Verde (Líder, etc.)</option>
                                <option value="amarela">Amarela</option>
                                <option value="laranja">Laranja / Vermelha</option>
                            </select>
                        </div>
                        <div class="flex justify-between items-center">
                            <label for="profitMargin" class="block text-sm font-medium text-gray-300">Margem de Lucro</label>
                            <span id="profit-value" class="font-bold text-accent-green text-lg">0%</span>
                        </div>
                        <input type="range" id="profitMargin" min="0" max="100" value="0" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                </details>

                <details>
                    <summary class="sidebar-summary flex justify-between items-center p-3 rounded-md hover:bg-gray-900/50 transition-colors cursor-pointer">
                        <span class="font-semibold text-lg text-white">Marketplaces</span>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </summary>
                    <div id="marketplaces-list" class="pt-4 space-y-3 pl-4 border-l border-gray-700 ml-3"></div>
                </details>
            </div>
        </aside>

        <!-- Marketplace Main Content -->
        <main class="lg:col-span-9 p-6 sm:p-8 relative">
            <header class="sticky top-0 z-10 bg-gray-800/50 backdrop-blur-sm -mx-6 -mt-6 sm:-mx-8 sm:-mt-8 mb-6 sm:mb-8 p-6 sm:p-8 flex justify-between items-center border-b border-gray-700">
                <h2 class="text-2xl font-bold text-white">Resultados da Simulação</h2>
                <button id="open-tax-calculator-btn" class="flex items-center gap-2 px-4 py-2 bg-accent-green text-bg-dark font-semibold rounded-lg hover:bg-accent-green-dark transition text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M224,96v56a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V96a16,16,0,0,1,16-16H208A16,16,0,0,1,224,96Zm-44,8a12,12,0,1,0,12,12A12,12,0,0,0,180,104ZM88,140a12,12,0,1,0-12-12A12,12,0,0,0,88,140Z"></path></svg>
                    <span>Calculadora de Taxas</span>
                </button>
            </header>
            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <div id="placeholder" class="col-span-full text-center py-20">
                    <h2 class="text-2xl font-semibold text-gray-400">Insira os custos e selecione um marketplace para começar</h2>
                    <p class="text-gray-500 mt-2">Os resultados aparecerão aqui em tempo real.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Tax Calculator Sidebar -->
    <div id="tax-calculator-sidebar" class="fixed top-0 right-0 w-full h-full overflow-y-auto">
         <div class="w-full max-w-lg tax-calc-panel rounded-l-2xl shadow-lg p-6 md:p-10 relative ml-auto min-h-full">
            <button id="close-tax-calculator-btn" class="absolute top-4 left-4 text-gray-400 hover:text-red-500 transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 256 256"><path d="M208.49,191.51a12,12,0,0,1-17,17L128,145,64.49,208.49a12,12,0,0,1-17-17L111,128,47.51,64.49a12,12,0,0,1,17-17L128,111l63.51-63.52a12,12,0,0,1,17,17L145,128Z"></path></svg>
            </button>
            <div id="tax-calc-content-wrapper"></div>
         </div>
    </div>


    <script>
    // IIFE to encapsulate Marketplace Calculator logic
    (function() {
        const officialMarketplaceData = {
            mercadoLivreClassico: { name: "Mercado Livre (Clássico)", group: "Mercado Livre", commission: 0.12, categories: { "Supermercado": 0.125, "Beleza e Cuidado Pessoal": 0.13, "Calçados, Roupas e Bolsas": 0.13, "Eletrônicos, Áudio e Vídeo": 0.115, "Celulares e Telefones": 0.115, "Acessórios para Veículos": 0.115, "Eletrodomésticos": 0.105, "Agro": 0.095, "Livros": 0.09 }, note: "Comissão exata por categoria. Frete calculado pela regra oficial." },
            mercadoLivrePremium: { name: "Mercado Livre (Premium)", group: "Mercado Livre", commission: 0.17, categories: { "Supermercado": 0.175, "Beleza e Cuidado Pessoal": 0.18, "Calçados, Roupas e Bolsas": 0.18, "Eletrônicos, Áudio e Vídeo": 0.165, "Celulares e Telefones": 0.165, "Acessórios para Veículos": 0.165, "Eletrodomésticos": 0.155, "Agro": 0.145, "Livros": 0.14 }, note: "Comissão exata por categoria. Frete calculado pela regra oficial." },
            shopeePadrao: { name: "Shopee (Padrão)", group: "Shopee", commission: 0.14, transactionFee: 0.02, note: "Comissão de 14% (teto R$100) + 2% de transação." },
            shopeeFreteGratis: { name: "Shopee (Frete Grátis)", group: "Shopee", commission: 0.20, transactionFee: 0.02, fixedFee: () => 3.00, note: "Comissão de 20% (teto R$100) + 2% de transação + R$3 por item." },
            amazon: { name: "Amazon", group: "Amazon", commission: 0.15, categories: { "Dispositivos Amazon": 0.20, "Computadores": 0.13, "Eletrônicos, Áudio e Vídeo": 0.13, "Videogames e Consoles": 0.14, "Celulares e Telefones": 0.11, "Calçados, Roupas e Bolsas": 0.16, "Beleza e Cuidado Pessoal": 0.15, "Casa, Cozinha e Ferramentas": 0.14, "Livros": 0.15, "Esportes e Aventura": 0.15, "Brinquedos e Jogos": 0.15 }, calculateCommission: (p, r) => Math.max(1.00, p * r), note: "Comissão por categoria. Mínimo R$1. Assume Plano Profissional." },
            magalu: { name: "Magazine Luiza", group: "Magalu", commission: 0.20, fixedFee: () => 5.00, note: "Comissão de até 20% e taxa fixa de R$5 por item." },
            americanas: { name: "Americanas", group: "Americanas", commission: 0.19, categories: { "Calçados, Roupas e Bolsas": 0.19, "Beleza e Cuidado Pessoal": 0.19, "Livros": 0.18, "Celulares e Telefones": 0.17, "Computadores": 0.17, "Eletrônicos, Áudio e Vídeo": 0.17, "Eletrodomésticos": 0.16, "Brinquedos e Jogos": 0.19, "Casa, Cozinha e Ferramentas": 0.19 }, fixedFee: () => 5.00, note: "Comissão por categoria e taxa fixa de R$5 por item." },
            shein: { name: "Shein", group: "Shein", commission: 0.16, getShippingBrokerageFee: (weight) => { if (weight <= 0.3) return 4.00; if (weight <= 2) return 5.00; if (weight <= 5) return 15.00; if (weight <= 9) return 32.00; return 32.00; }, note: "Comissão de 16% + Taxa de Corretagem de Frete por peso." },
            tiktokShop: { name: "TikTok Shop", group: "TikTok Shop", commission: 0.06, shippingFeeRate: 0.06, fixedFee: (p) => p < 79 ? 2.00 : 0, note: "Comissão 6% + Taxa de Envio 6% + taxa fixa R$2 (se < R$79)." }
        };
        const unifiedCategories = [ "Demais categorias", "Calçados, Roupas e Bolsas", "Beleza e Cuidado Pessoal", "Eletrônicos, Áudio e Vídeo", "Celulares e Telefones", "Computadores", "Videogames e Consoles", "Acessórios para Veículos", "Casa, Cozinha e Ferramentas", "Eletrodomésticos", "Esportes e Aventura", "Brinquedos e Jogos", "Supermercado", "Livros", "Agro", "Dispositivos Amazon" ];

        const sidebar = document.getElementById('sidebar');
        const marketplacesList = document.getElementById('marketplaces-list');
        const categorySelect = document.getElementById('categorySelect');
        const resultsGrid = document.getElementById('results-grid');
        const profitValueSpan = document.getElementById('profit-value');
        const addCostBtn = document.getElementById('add-cost-btn');
        const additionalCostsContainer = document.getElementById('additional-costs-container');

        const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const toPercent = (value, total) => total > 0 ? `${(value / total * 100).toFixed(1)}%` : '0.0%';
        
        const mlShippingCosts = {
            verde: { '99.99': { 0.3: 11.97, 0.5: 12.87, 1: 13.47, 2: 14.07, 3: 14.97, 4: 16.17, 5: 17.07, 9: 26.67, 13: 39.57, 17: 44.07, 23: 51.57, 30: 59.37, 40: 61.17, 50: 63.27, 60: 67.47, 70: 72.27, 80: 75.57, 90: 83.97, 100: 95.97, 125: 107.37, 150: 113.97, Infinity: 149.67 }, '119.99': { 0.3: 13.97, 0.5: 15.02, 1: 15.72, 2: 16.42, 3: 17.47, 4: 18.87, 5: 19.92, 9: 31.12, 13: 46.17, 17: 51.42, 23: 60.17, 30: 69.27, 40: 71.37, 50: 73.82, 60: 78.72, 70: 84.32, 80: 88.17, 90: 97.97, 100: 111.97, 125: 125.27, 150: 132.97, Infinity: 174.62 }, '149.99': { 0.3: 15.96, 0.5: 17.16, 1: 17.96, 2: 18.76, 3: 19.96, 4: 21.56, 5: 22.76, 9: 35.56, 13: 52.76, 17: 58.76, 23: 68.76, 30: 79.16, 40: 81.56, 50: 84.36, 60: 89.96, 70: 96.36, 80: 100.76, 90: 111.96, 100: 127.96, 125: 143.16, 150: 151.96, Infinity: 199.56 }, '199.99': { 0.3: 17.96, 0.5: 19.31, 1: 20.21, 2: 21.11, 3: 22.46, 4: 24.26, 5: 25.61, 9: 40.01, 13: 59.36, 17: 66.11, 23: 77.36, 30: 89.06, 40: 91.76, 50: 94.91, 60: 101.21, 70: 108.41, 80: 113.36, 90: 125.96, 100: 143.96, 125: 161.06, 150: 170.96, Infinity: 224.51 }, 'Infinity': { 0.3: 19.95, 0.5: 21.45, 1: 22.45, 2: 23.45, 3: 24.95, 4: 26.95, 5: 28.45, 9: 44.45, 13: 65.95, 17: 73.45, 23: 85.95, 30: 98.95, 40: 101.95, 50: 105.45, 60: 112.45, 70: 120.45, 80: 125.95, 90: 139.95, 100: 159.95, 125: 178.95, 150: 189.95, Infinity: 249.45 } },
            amarela: { '99.99': { 0.3: 15.96, 0.5: 17.16, 1: 17.96, 2: 18.76, 3: 19.96, 4: 21.56, 5: 22.76, 9: 35.56, 13: 52.76, 17: 58.76, 23: 68.76, 30: 79.16, 40: 81.56, 50: 84.36, 60: 89.96, 70: 96.36, 80: 100.76, 90: 111.96, 100: 127.96, 125: 143.16, 150: 151.96, Infinity: 199.56 }, '119.99': { 0.3: 17.96, 0.5: 19.31, 1: 20.21, 2: 21.11, 3: 22.46, 4: 24.26, 5: 25.61, 9: 40.01, 13: 59.36, 17: 66.11, 23: 77.36, 30: 89.06, 40: 91.76, 50: 94.91, 60: 101.21, 70: 108.41, 80: 113.36, 90: 125.96, 100: 143.96, 125: 161.06, 150: 170.96, Infinity: 224.51 }, '149.99': { 0.3: 19.95, 0.5: 21.45, 1: 22.45, 2: 23.45, 3: 24.95, 4: 26.95, 5: 28.45, 9: 44.45, 13: 65.95, 17: 73.45, 23: 85.95, 30: 98.95, 40: 101.95, 50: 105.45, 60: 112.45, 70: 120.45, 80: 125.95, 90: 139.95, 100: 159.95, 125: 178.95, 150: 189.95, Infinity: 249.45 }, '199.99': { 0.3: 21.95, 0.5: 23.60, 1: 24.70, 2: 25.80, 3: 27.45, 4: 29.65, 5: 31.30, 9: 48.90, 13: 72.55, 17: 80.80, 23: 94.55, 30: 108.85, 40: 112.15, 50: 116.00, 60: 123.70, 70: 132.50, 80: 138.55, 90: 153.95, 100: 175.95, 125: 196.85, 150: 208.95, Infinity: 274.40 }, 'Infinity': { 0.3: 23.94, 0.5: 25.74, 1: 26.94, 2: 28.14, 3: 29.94, 4: 32.34, 5: 34.14, 9: 53.34, 13: 79.14, 17: 88.14, 23: 103.14, 30: 118.74, 40: 122.34, 50: 126.54, 60: 134.94, 70: 144.54, 80: 151.14, 90: 167.94, 100: 191.94, 125: 214.74, 150: 227.94, Infinity: 299.34 } },
            laranja: { 'Infinity': { 0.3: 39.9, 0.5: 42.9, 1: 44.9, 2: 46.9, 3: 49.9, 4: 53.9, 5: 56.9, 9: 88.9, 13: 131.9, 17: 146.9, 23: 171.9, 30: 197.9, 40: 203.9, 50: 210.9, 60: 224.9, 70: 240.9, 80: 251.9, 90: 279.9, 100: 319.9, 125: 357.9, 150: 379.9, Infinity: 498.9 } }
        };

        function getMlShippingCost(weight, price, reputation) {
            if (price < 79) return 0;
            const tables = mlShippingCosts[reputation];
            const priceBrackets = Object.keys(tables).map(parseFloat).sort((a, b) => a - b);
            let chosenPriceBracket = priceBrackets.find(bracket => price <= bracket) || Infinity;
            const costTable = tables[chosenPriceBracket];
            const weightTiers = Object.keys(costTable).map(parseFloat).sort((a, b) => a - b);
            let chosenWeightTier = weightTiers.find(tier => weight <= tier) || Infinity;
            return costTable[chosenWeightTier];
        }
        
        function addCostRow() {
            const rowId = `cost-row-${Date.now()}`;
            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'flex items-center gap-2';
            row.innerHTML = `<input type="text" placeholder="Descrição" class="input-field rounded-md p-2 w-1/2 cost-desc"><input type="number" placeholder="Valor" value="" class="input-field rounded-md p-2 w-1/4 cost-value"><select class="select-field rounded-md p-2 w-1/4 cost-type"><option value="rs">R$</option><option value="percent">%</option></select><button class="text-red-500 hover:text-red-400 remove-cost-btn" data-rowid="${rowId}">&times;</button>`;
            additionalCostsContainer.appendChild(row);
            row.querySelector('.remove-cost-btn').addEventListener('click', (e) => {
                document.getElementById(e.target.dataset.rowid).remove();
                calculateAndRender();
            });
            calculateAndRender(); // Recalculate when a new cost is added
        }

        function populateUI() {
            categorySelect.innerHTML = unifiedCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            const grouped = Object.entries(officialMarketplaceData).reduce((acc, [key, mkt]) => {
                if (!acc[mkt.group]) acc[mkt.group] = [];
                acc[mkt.group].push({ key, ...mkt });
                return acc;
            }, {});
            let html = '';
            for (const groupName in grouped) {
                html += `<div class="space-y-2"><p class="font-medium text-white">${groupName}</p>`;
                grouped[groupName].forEach(mkt => {
                    html += `<label class="flex items-center text-gray-300 font-normal"><input type="checkbox" name="marketplace" value="${mkt.key}" class="h-4 w-4 rounded border-gray-500 mr-3"><span>${mkt.name.replace(`(${mkt.group})`, '').trim()}</span></label>`;
                });
                html += `</div>`;
            }
            marketplacesList.innerHTML = html;
        }

        function calculateAndRender() {
            const productCost = parseFloat(document.getElementById('productCost').value) || 0;
            let totalFixedOtherCosts = 0;
            let totalPercentageOtherCosts = 0;
            const additionalCostRows = document.querySelectorAll('#additional-costs-container > div');
            additionalCostRows.forEach(row => {
                const value = parseFloat(row.querySelector('.cost-value').value) || 0;
                const type = row.querySelector('.cost-type').value;
                if (type === 'rs') {
                    totalFixedOtherCosts += value;
                } else {
                    totalPercentageOtherCosts += value / 100;
                }
            });

            const productWeight = parseFloat(document.getElementById('productWeight').value) || 0;
            const selectedCategory = categorySelect.value;
            const taxRate = parseFloat(document.getElementById('taxRate').value) / 100 || 0;
            const manualShippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
            const profitMargin = parseFloat(document.getElementById('profitMargin').value) / 100 || 0;
            const mlReputation = document.getElementById('mlReputation').value;
            
            profitValueSpan.textContent = `${(profitMargin * 100).toFixed(0)}%`;

            const selectedMkts = Array.from(document.querySelectorAll('input[name="marketplace"]:checked')).map(cb => cb.value);
            
            resultsGrid.innerHTML = '';
            if (selectedMkts.length === 0 || productCost === 0) {
                 resultsGrid.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6';
                 resultsGrid.innerHTML = `<div id="placeholder" class="col-span-full text-center py-20">
                    <h2 class="text-2xl font-semibold text-gray-400">Insira os custos e selecione um marketplace para começar</h2>
                    <p class="text-gray-500 mt-2">Os resultados aparecerão aqui em tempo real.</p>
                </div>`;
                return;
            }

            // --- COLUMN-BASED LAYOUT LOGIC ---
            resultsGrid.className = 'flex w-full gap-6 flex-col md:flex-row'; // Use flexbox for columns
            const numColumns = window.innerWidth >= 1280 ? 3 : (window.innerWidth >= 768 ? 2 : 1);
            
            for (let i = 0; i < numColumns; i++) {
                const column = document.createElement('div');
                column.className = 'flex flex-col gap-6 w-full';
                resultsGrid.appendChild(column);
            }
            const columns = resultsGrid.querySelectorAll('.flex-col');
            // --- END ---

            const cardDataArray = [];
            selectedMkts.forEach(mktKey => {
                const mkt = officialMarketplaceData[mktKey];
                const commissionRate = (mkt.categories && mkt.categories[selectedCategory]) || mkt.commission;
                const transactionFeeRate = mkt.transactionFee || 0;
                const shippingFeeRate = mkt.shippingFeeRate || 0;
                let shippingCostForCalc = manualShippingCost;
                let fixedFee = 0;
                let isMlSpecialCase = mktKey.includes('mercadoLivre');
                let isShopeeCase = mktKey.includes('shopee');
                let isSheinCase = mktKey.includes('shein');
                let isTikTokCase = mktKey.includes('tiktok');
                let denominator = 1 - commissionRate - taxRate - profitMargin - transactionFeeRate - shippingFeeRate - totalPercentageOtherCosts;

                if (denominator <= 0 && !isShopeeCase && !isTikTokCase) { 
                    cardDataArray.push({ error: true, mkt: mkt });
                    return; 
                }

                let sellingPrice;
                const baseCosts = productCost + totalFixedOtherCosts;

                if (isMlSpecialCase) {
                    let tempDenominator = 1 - commissionRate - taxRate - profitMargin - totalPercentageOtherCosts;
                    let initialPriceGuess = (baseCosts + 6) / tempDenominator;
                    shippingCostForCalc = getMlShippingCost(productWeight, initialPriceGuess, mlReputation);
                    let stablePrice = (baseCosts + shippingCostForCalc + (initialPriceGuess < 79 ? 6 : 0)) / tempDenominator;
                    shippingCostForCalc = getMlShippingCost(productWeight, stablePrice, mlReputation);
                    fixedFee = stablePrice < 79 ? 6.00 : 0;
                    sellingPrice = (baseCosts + shippingCostForCalc + fixedFee) / tempDenominator;
                } else {
                    if (isSheinCase) { shippingCostForCalc = mkt.getShippingBrokerageFee(productWeight); } 
                    else if (isTikTokCase) { shippingCostForCalc = 0; }
                    fixedFee = mkt.fixedFee ? mkt.fixedFee(0) : 0;
                    sellingPrice = (baseCosts + shippingCostForCalc + fixedFee) / denominator;
                    fixedFee = mkt.fixedFee ? mkt.fixedFee(sellingPrice) : 0;
                    sellingPrice = (baseCosts + shippingCostForCalc + fixedFee) / denominator;
                }

                let commissionValue, shippingFeeValue = 0;
                if(isShopeeCase) { commissionValue = Math.min(sellingPrice * commissionRate, 100); } 
                else { commissionValue = mkt.calculateCommission ? mkt.calculateCommission(sellingPrice, commissionRate) : sellingPrice * commissionRate; }

                if(isTikTokCase) { shippingFeeValue = sellingPrice * shippingFeeRate; }
                
                if((isShopeeCase && commissionValue === 100)) {
                    const fixedCostsWithCappedFees = baseCosts + shippingCostForCalc + fixedFee + commissionValue;
                    const newDenominator = 1 - taxRate - profitMargin - transactionFeeRate - totalPercentageOtherCosts;
                    if (newDenominator <= 0) { 
                        cardDataArray.push({ error: true, mkt: mkt });
                        return;
                    }
                    sellingPrice = fixedCostsWithCappedFees / newDenominator;
                }

                const transactionFeeValue = sellingPrice * transactionFeeRate;
                const taxValue = sellingPrice * taxRate;
                const profitValue = sellingPrice * profitMargin;
                const additionalCostsCalculated = [];
                additionalCostRows.forEach(row => {
                    const desc = row.querySelector('.cost-desc').value || 'Custo Adicional';
                    const value = parseFloat(row.querySelector('.cost-value').value) || 0;
                    const type = row.querySelector('.cost-type').value;
                    additionalCostsCalculated.push({ desc, value: type === 'rs' ? value : sellingPrice * (value / 100) });
                });
                const totalAdditionalCostsValue = additionalCostsCalculated.reduce((sum, cost) => sum + cost.value, 0);
                const totalFees = commissionValue + transactionFeeValue + fixedFee + shippingFeeValue;
                const totalCosts = productCost + totalAdditionalCostsValue + shippingCostForCalc + taxValue + totalFees;
                
                cardDataArray.push({
                    error: false, ...mkt, sellingPrice, profitValue,
                    breakdown: { productCost, additionalCosts: additionalCostsCalculated, shippingCost: shippingCostForCalc, commissionValue, transactionFeeValue, fixedFee, shippingFeeValue, taxValue, totalFees, totalCosts }
                });
            });

            // Distribute cards into columns
            cardDataArray.forEach((data, index) => {
                const columnIndex = index % numColumns;
                if (data.error) {
                    columns[columnIndex].innerHTML += generateErrorCard(data.mkt);
                } else {
                    columns[columnIndex].innerHTML += generateResultCard(data);
                }
            });
            
            document.querySelectorAll('[data-toggle="details"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const toggleButton = e.currentTarget;
                    const targetId = toggleButton.getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);
                    toggleButton.classList.toggle('open');
                    targetElement.classList.toggle('open');
                });
            });
        }
        
        function generateErrorCard(mkt) {
            return `<div class="card rounded-lg p-5 flex flex-col border-red-500/50"><h3 class="font-bold text-xl text-white">${mkt.name}</h3><div class="flex-grow flex items-center justify-center"><p class="text-center text-red-400">Cálculo impossível.<br>Taxas + Lucro excedem 100%.</p></div></div>`;
        }
        
        function generateResultCard(data) {
            const { name, note, sellingPrice, profitValue, breakdown } = data;
            const detailsId = `details-${name.replace(/[^a-zA-Z0-9]/g, '')}`;
            
            let additionalCostsHtml = breakdown.additionalCosts.map(cost => 
                cost.value > 0 ? `<div class="flex justify-between items-center text-xs"><span class="text-gray-400">${cost.desc}</span><span class="text-right font-mono">${formatCurrency(cost.value)} <span class="text-gray-500">(${toPercent(cost.value, sellingPrice)})</span></span></div>` : ''
            ).join('');

            return `
                <div class="card rounded-xl shadow-lg flex flex-col overflow-hidden border border-transparent hover:border-accent-green/50 transition-all duration-300 bg-gradient-to-br from-gray-800 to-gray-900">
                    <div class="p-5 flex flex-col">
                        <h3 class="font-bold text-xl text-white truncate">${name}</h3>
                        <p class="text-xs text-gray-500 mb-4 h-5">${note}</p>
                        
                        <div class="my-6 text-center flex flex-col justify-center">
                            <p class="text-sm text-gray-400">Preço de Venda Sugerido</p>
                            <p class="text-4xl font-bold text-accent-green tracking-tight">${formatCurrency(sellingPrice)}</p>
                        </div>

                        <div class="flex justify-between items-center bg-gray-900/70 rounded-lg p-3">
                            <span class="text-sm text-gray-300">Seu Lucro Estimado</span>
                            <span class="text-lg font-semibold text-white">${formatCurrency(profitValue)}</span>
                        </div>
                    </div>

                    <div class="bg-gray-900/50 border-t border-gray-700/50 mt-auto">
                        <div id="${detailsId}" class="details-content text-sm space-y-2 px-5 pb-4">
                            <div class="pt-4"></div>
                            <div class="flex justify-between items-center text-xs"><span class="text-gray-400">Custo do Produto</span><span class="text-right font-mono">${formatCurrency(breakdown.productCost)} <span class="text-gray-500">(${toPercent(breakdown.productCost, sellingPrice)})</span></span></div>
                            ${additionalCostsHtml}
                            <div class="flex justify-between items-center text-xs"><span class="text-gray-400">Frete (Custo)</span><span class="text-right font-mono">${formatCurrency(breakdown.shippingCost)} <span class="text-gray-500">(${toPercent(breakdown.shippingCost, sellingPrice)})</span></span></div>
                            <hr class="border-gray-700/50 my-2">
                            <div class="flex justify-between items-center text-xs"><span class="text-gray-400">Comissão Mkt</span><span class="text-right font-mono">${formatCurrency(breakdown.commissionValue)} <span class="text-gray-500">(${toPercent(breakdown.commissionValue, sellingPrice)})</span></span></div>
                            ${breakdown.transactionFeeValue > 0 ? `<div class="flex justify-between items-center text-xs"><span class="text-gray-400">Taxa de Transação</span><span class="text-right font-mono">${formatCurrency(breakdown.transactionFeeValue)} <span class="text-gray-500">(${toPercent(breakdown.transactionFeeValue, sellingPrice)})</span></span></div>` : ''}
                            ${breakdown.shippingFeeValue > 0 ? `<div class="flex justify-between items-center text-xs"><span class="text-gray-400">Taxa de Envio</span><span class="text-right font-mono">${formatCurrency(breakdown.shippingFeeValue)} <span class="text-gray-500">(${toPercent(breakdown.shippingFeeValue, sellingPrice)})</span></span></div>` : ''}
                            ${breakdown.fixedFee > 0 ? `<div class="flex justify-between items-center text-xs"><span class="text-gray-400">Taxa Fixa</span><span class="text-right font-mono">${formatCurrency(breakdown.fixedFee)} <span class="text-gray-500">(${toPercent(breakdown.fixedFee, sellingPrice)})</span></span></div>` : ''}
                            <div class="flex justify-between items-center text-xs"><span class="text-gray-400">Impostos</span><span class="text-right font-mono">${formatCurrency(breakdown.taxValue)} <span class="text-gray-500">(${toPercent(breakdown.taxValue, sellingPrice)})</span></span></div>
                            <hr class="border-gray-700/50 my-2">
                            <div class="flex justify-between items-center text-sm font-bold"><span class="text-gray-300">Total de Custos</span><span class="text-right font-mono">${formatCurrency(breakdown.totalCosts)} <span class="text-gray-500">(${toPercent(breakdown.totalCosts, sellingPrice)})</span></span></div>
                        </div>
                        <button data-toggle="details" data-target="${detailsId}" class="details-toggle w-full text-center p-3 text-sm text-gray-400 hover:text-white flex justify-center items-center gap-2 transition-colors">
                            <span>Detalhes</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                    </div>
                </div>`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateUI();
            sidebar.addEventListener('input', calculateAndRender);
            addCostBtn.addEventListener('click', addCostRow);
            calculateAndRender();
            window.addEventListener('resize', calculateAndRender); // Recalculate layout on resize
        });
    })();
    
    // IIFE to encapsulate Tax Calculator logic
    (function() {
        const taxCalcHTML = `
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Calculadora de Taxas</h1>
                    <p class="text-gray-400 mt-1">Simule e saiba exatamente quanto irá receber.</p>
                </div>
                <button id="taxCalcOpenSettingsBtn" class="text-gray-400 hover:text-accent-green p-2 rounded-lg transition">
                     <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 256 256"><path d="M244.8,142.48a12,12,0,0,1-13.6,13.6L224,152.93V160a16,16,0,0,1-16,16h-24a16,16,0,0,1-16-16v-8.42l-14.48,5.8a12,12,0,0,1-16-6.4l-16-40a12,12,0,0,1,3.2-16.8l12-8L136,84.07V72a16,16,0,0,1-16-16h-4a16,16,0,0,1-16,16v12.07l-12-8a12,12,0,0,1,3.2-16.8l16-40a12,12,0,0,1,16-6.4L137.6,34.4a12,12,0,0,1,14.4,14.4L148.8,60.8l12.8,8.53V64a16,16,0,0,1,16-16h24a16,16,0,0,1,16,16v8.93l7.2,3.15a12,12,0,0,1,9.6,15.2Zm-86.25,5.52a28,28,0,1,0-29.1,0,12,12,0,0,1-21,9.6l-16-40a12,12,0,0,1,3.2-16.8L107.6,96,96,88.48l-9.6-6.4-12-8-12,8L50.4,90.4l-12,8a12,12,0,0,1,3.2,16.8l16,40a12,12,0,0,1-2.4,15.2l-13.6,13.6a12,12,0,0,1-12.8-18.4L32,176.93V160a16,16,0,0,1,16-16h24a16,16,0,0,1,16,16v8.42l14.48-5.8a12,12,0,0,1,16,6.4l16,40a12,12,0,0,1-3.2,16.8l-12,8L120,224.07V232a16,16,0,0,1-16,16h-4a16,16,0,0,1-16-16v-12.07l12-8a12,12,0,0,1-3.2-16.8l-16-40a12,12,0,0,1-16,6.4L46.4,168.8a12,12,0,0,1-14.4-14.4L35.2,142.4,22.4,134.87V128a16,16,0,0,1,16-16h4a16,16,0,0,1,16,16v12.07l12,8a12,12,0,0,1-3.2,16.8l-16,40a12,12,0,0,1,2.4-15.2l13.6-13.6a12,12,0,0,1,12.8,18.4L83.2,201.6l12-8,12,8,9.6,6.4,12-8,12-8,12,8,13.6-13.6a12,12,0,0,1,21-9.6Z"></path></svg>
                </button>
            </div>
            <div class="flex flex-col gap-8">
                <div class="space-y-6">
                    <div class="flex border rounded-lg p-1" style="border-color: var(--border-color); background-color: var(--bg-dark);">
                        <button id="taxCalcBtnCharge" class="w-1/2 p-2 rounded-md text-sm font-medium transition">Quero Cobrar</button>
                        <button id="taxCalcBtnReceive" class="w-1/2 p-2 rounded-md text-sm font-medium transition">Quero Receber</button>
                    </div>
                    <div>
                        <label for="taxCalcAmountInput" id="taxCalcAmountLabel" class="block text-sm font-medium text-gray-300 mb-1">Qual o valor da venda?</label>
                        <div class="relative"><span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">R$</span><input type="text" id="taxCalcAmountInput" class="input-field w-full pl-9 pr-4 py-2 rounded-lg" value=""></div>
                    </div>
                    <div>
                        <label for="taxCalcPaymentMethod" class="block text-sm font-medium text-gray-300 mb-1">Meio de Pagamento</label>
                        <select id="taxCalcPaymentMethod" class="select-field w-full p-2 rounded-lg"><option value="credit_card">Cartão de Crédito</option><option value="boleto">Boleto</option><option value="pix">PIX</option></select>
                    </div>
                    <div id="taxCalcCreditCardOptions" class="space-y-6">
                        <div>
                            <label for="taxCalcInstallments" class="block text-sm font-medium text-gray-300 mb-1">Número de Parcelas</label>
                            <select id="taxCalcInstallments" class="select-field w-full p-2 rounded-lg"><option value="1">1x (à vista)</option><option value="2">2x</option><option value="3">3x</option><option value="4">4x</option><option value="5">5x</option><option value="6">6x</option><option value="7">7x</option><option value="8">8x</option><option value="9">9x</option><option value="10">10x</option><option value="11">11x</option><option value="12">12x</option></select>
                        </div>
                    </div>
                </div>
                <div class="rounded-lg p-6 flex flex-col justify-center" style="background-color: var(--bg-dark);">
                    <h2 class="text-xl font-semibold text-white mb-4 text-center">Resultado da Simulação</h2>
                    <div id="taxCalcResults" class="space-y-4"></div>
                </div>
            </div>
            <div class="text-center mt-8"><p class="text-xs text-gray-500">* As taxas são baseadas nas informações fornecidas. Consulte seu contrato para valores exatos.</p></div>
            <div id="taxCalcSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-overlay opacity-0 pointer-events-none">
                <div class="modal-content rounded-2xl shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95">
                    <div class="p-6 sticky top-0 border-b" style="background-color: var(--bg-card); border-color: var(--border-color);">
                        <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-white">Configurar Taxas</h2><button id="taxCalcCloseSettingsBtn" class="text-gray-400 hover:text-red-500 transition"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 256 256"><path d="M208.49,191.51a12,12,0,0,1-17,17L128,145,64.49,208.49a12,12,0,0,1-17-17L111,128,47.51,64.49a12,12,0,0,1,17-17L128,111l63.51-63.52a12,12,0,0,1,17,17L145,128Z"></path></svg></button></div>
                    </div>
                    <div class="p-6 space-y-8">
                        <div class="space-y-4"><h3 class="text-lg font-semibold text-gray-300 border-b pb-2" style="border-color: var(--border-color);">Cartão de Crédito (%)</h3><div id="taxCalcCreditCardRatesContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4"><h3 class="text-lg font-semibold text-gray-300 border-b pb-2" style="border-color: var(--border-color);">PIX</h3><div><label for="taxCalcPixRate" class="block text-sm font-medium text-gray-400 mb-1">Taxa (%)</label><input type="text" id="taxCalcPixRate" class="input-field w-full p-2 rounded-lg"></div></div>
                            <div class="space-y-4"><h3 class="text-lg font-semibold text-gray-300 border-b pb-2" style="border-color: var(--border-color);">Boleto</h3><div><label for="taxCalcBoletoRate" class="block text-sm font-medium text-gray-400 mb-1">Taxa Fixa (R$)</label><input type="text" id="taxCalcBoletoRate" class="input-field w-full p-2 rounded-lg"></div></div>
                        </div>
                    </div>
                    <div class="p-6 sticky bottom-0 border-t flex justify-end gap-4" style="background-color: var(--bg-card); border-color: var(--border-color);"><button id="taxCalcCancelSettingsBtn" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 transition">Cancelar</button><button id="taxCalcSaveSettingsBtn" class="px-4 py-2 bg-accent-green text-bg-dark font-semibold rounded-lg hover:bg-accent-green-dark transition">Salvar Alterações</button></div>
                </div>
            </div>`;
        
        document.getElementById('tax-calc-content-wrapper').innerHTML = taxCalcHTML;

        let rates = { pix: 1.19, boleto: 3.49, creditCard: { 1: 3.79, 2: 5.28, 3: 7.67, 4: 9.08, 5: 10.54, 6: 11.96, 7: 13.37, 8: 14.79, 9: 16.22, 10: 17.64, 11: 19.06, 12: 20.51 } };
        const amountInput = document.getElementById('taxCalcAmountInput'), paymentMethodSelect = document.getElementById('taxCalcPaymentMethod'), installmentsSelect = document.getElementById('taxCalcInstallments'), creditCardOptionsDiv = document.getElementById('taxCalcCreditCardOptions'), resultsDiv = document.getElementById('taxCalcResults'), btnCharge = document.getElementById('taxCalcBtnCharge'), btnReceive = document.getElementById('taxCalcBtnReceive'), amountLabel = document.getElementById('taxCalcAmountLabel'), openSettingsBtn = document.getElementById('taxCalcOpenSettingsBtn'), closeSettingsBtn = document.getElementById('taxCalcCloseSettingsBtn'), cancelSettingsBtn = document.getElementById('taxCalcCancelSettingsBtn'), saveSettingsBtn = document.getElementById('taxCalcSaveSettingsBtn'), settingsModal = document.getElementById('taxCalcSettingsModal'), modalContent = settingsModal.querySelector('.modal-content'), pixRateInput = document.getElementById('taxCalcPixRate'), boletoRateInput = document.getElementById('taxCalcBoletoRate'), creditCardRatesContainer = document.getElementById('taxCalcCreditCardRatesContainer');
        let calculationMode = 'charge';
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(isNaN(value) ? 0 : value);
        const parseCurrency = (value) => { if (typeof value !== 'string') return 0; const number = parseFloat(value.replace("R$", "").replace(/\./g, '').replace(',', '.').trim()); return isNaN(number) ? 0 : number; };
        const toggleCreditCardOptions = () => creditCardOptionsDiv.style.display = paymentMethodSelect.value === 'credit_card' ? 'block' : 'none';
        const updateToggleUI = () => {
            if (calculationMode === 'charge') {
                btnCharge.classList.add('bg-accent-green', 'text-bg-dark', 'font-semibold'); btnCharge.classList.remove('text-gray-300');
                btnReceive.classList.remove('bg-accent-green', 'text-bg-dark', 'font-semibold'); btnReceive.classList.add('text-gray-300');
                amountLabel.textContent = 'Qual o valor da venda? (a cobrar)';
            } else {
                btnReceive.classList.add('bg-accent-green', 'text-bg-dark', 'font-semibold'); btnReceive.classList.remove('text-gray-300');
                btnCharge.classList.remove('bg-accent-green', 'text-bg-dark', 'font-semibold'); btnCharge.classList.add('text-gray-300');
                amountLabel.textContent = 'Quanto você quer receber? (líquido)';
            }
        };
        const createResultCard = (title, value, icon) => `<div class="result-card-dark p-4 rounded-lg shadow-sm flex items-center"><div class="mr-4 text-accent-green">${icon}</div><div><h3 class="text-sm font-medium">${title}</h3><p class="text-xl font-semibold">${value}</p></div></div>`;
        const calculate = () => {
            const inputValue = parseCurrency(amountInput.value);
            const paymentMethod = paymentMethodSelect.value;
            const installments = parseInt(installmentsSelect.value);
            let saleAmount = 0, netAmount = 0, feeValue = 0, receiveDate = '', feeText = '';
            if (inputValue <= 0) { resultsDiv.innerHTML = `<p class="text-center text-gray-400">Insira um valor válido.</p>`; return; }
            switch (paymentMethod) {
                case 'pix': if (calculationMode === 'charge') { saleAmount = inputValue; feeValue = saleAmount * (rates.pix / 100); netAmount = saleAmount - feeValue; } else { netAmount = inputValue; saleAmount = netAmount / (1 - (rates.pix / 100)); feeValue = saleAmount - netAmount; } receiveDate = 'Instantâneo'; feeText = `${formatCurrency(feeValue)} (${String(rates.pix).replace('.', ',')}% a)`; break;
                case 'boleto': if (calculationMode === 'charge') { saleAmount = inputValue; feeValue = rates.boleto; netAmount = saleAmount - feeValue; } else { netAmount = inputValue; saleAmount = netAmount + rates.boleto; feeValue = rates.boleto; } receiveDate = 'Em 2 dias úteis'; feeText = `${formatCurrency(feeValue)} (taxa fixa)`; break;
                case 'credit_card': const ratePercent = rates.creditCard[installments]; if (calculationMode === 'charge') { saleAmount = inputValue; feeValue = saleAmount * (ratePercent / 100); netAmount = saleAmount - feeValue; } else { netAmount = inputValue; saleAmount = netAmount / (1 - (ratePercent / 100)); feeValue = saleAmount - netAmount; } receiveDate = 'Em até 15 dias'; feeText = `${formatCurrency(feeValue)} (${String(ratePercent).replace('.', ',')}% a)`; break;
            }
            let finalCardHTML = '';
            if (calculationMode === 'receive' && saleAmount > netAmount) {
                const discountPercent = ((saleAmount - netAmount) / saleAmount) * 100;
                const discountIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" /><path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" /></svg>`;
                finalCardHTML = createResultCard('Desconto para o cliente', `${discountPercent.toFixed(2).replace('.', ',')}%`, discountIcon);
            } else {
                const calendarIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`;
                finalCardHTML = createResultCard('Previsão de recebimento', receiveDate, calendarIcon);
            }
            const walletIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25-2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 3a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 12m15-3V6a2.25 2.25 0 00-2.25-2.25H8.25A2.25 2.25 0 006 6v3m15 6v-2.25M3 15v-2.25" /></svg>`;
            const feeIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>`;
            const priceIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            resultsDiv.innerHTML = createResultCard('Para receber (líquido)', formatCurrency(netAmount), walletIcon) + createResultCard('Você deveria cobrar', formatCurrency(saleAmount), priceIcon) + createResultCard('Taxas da venda', feeText, feeIcon) + finalCardHTML;
        };
        const openSettingsModal = () => { pixRateInput.value = String(rates.pix).replace('.', ','); boletoRateInput.value = String(rates.boleto).replace('.', ','); Object.keys(rates.creditCard).forEach(i => document.getElementById(`taxCalcRate-${i}`).value = String(rates.creditCard[i]).replace('.', ',')); settingsModal.classList.remove('opacity-0', 'pointer-events-none'); modalContent.classList.remove('scale-95'); };
        const closeSettingsModal = () => { settingsModal.classList.add('opacity-0', 'pointer-events-none'); modalContent.classList.add('scale-95'); };
        const saveSettings = () => { const newRates = { creditCard: {} }; newRates.pix = parseFloat(pixRateInput.value.replace(',', '.')) || 0; newRates.boleto = parseFloat(boletoRateInput.value.replace(',', '.')) || 0; for (let i = 1; i <= 12; i++) { const input = document.getElementById(`taxCalcRate-${i}`); newRates.creditCard[i] = parseFloat(input.value.replace(',', '.')) || 0; } rates = newRates; localStorage.setItem('precifyTaxCalculatorRates', JSON.stringify(rates)); closeSettingsModal(); calculate(); };
        const loadSettings = () => { const savedRates = localStorage.getItem('precifyTaxCalculatorRates'); if (savedRates) rates = JSON.parse(savedRates); };
        const generateCreditCardRateInputs = () => { for (let i = 1; i <= 12; i++) { const div = document.createElement('div'); div.innerHTML = `<label for="taxCalcRate-${i}" class="block text-sm font-medium text-gray-400 mb-1">${i}x</label><input type="text" id="taxCalcRate-${i}" class="input-field w-full p-2 rounded-lg">`; creditCardRatesContainer.appendChild(div); } };
        
        [amountInput, paymentMethodSelect, installmentsSelect].forEach(el => el.addEventListener('input', calculate));
        paymentMethodSelect.addEventListener('change', toggleCreditCardOptions);
        btnCharge.addEventListener('click', () => { calculationMode = 'charge'; updateToggleUI(); calculate(); });
        btnReceive.addEventListener('click', () => { calculationMode = 'receive'; updateToggleUI(); calculate(); });
        openSettingsBtn.addEventListener('click', openSettingsModal);
        closeSettingsBtn.addEventListener('click', closeSettingsModal);
        cancelSettingsBtn.addEventListener('click', closeSettingsModal);
        saveSettingsBtn.addEventListener('click', saveSettings);
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) closeSettingsModal(); });

        loadSettings();
        generateCreditCardRateInputs();
        toggleCreditCardOptions();
        updateToggleUI();
        calculate();
    })();

    // Sidebar toggle logic
    (function() {
        const openBtn = document.getElementById('open-tax-calculator-btn');
        const closeBtn = document.getElementById('close-tax-calculator-btn');
        const sidebar = document.getElementById('tax-calculator-sidebar');

        openBtn.addEventListener('click', () => sidebar.classList.add('active'));
        closeBtn.addEventListener('click', () => sidebar.classList.remove('active'));

        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', event => {
            if (event.key === 'F12' || (event.ctrlKey && event.shiftKey && (event.key === 'I' || event.key === 'i')) || (event.ctrlKey && (event.key === 'U' || event.key === 'u'))) {
                event.preventDefault();
            }
        });
    })();
    </script>
</body>
</html>

